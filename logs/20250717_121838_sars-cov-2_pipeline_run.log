2025-07-17 12:18:38,390 - INFO - Logging initialized. Log file at: logs/20250717_121838_sars-cov-2_pipeline_run.log
2025-07-17 12:18:38,390 - INFO - ================== STARTING PIPELINE FOR: SARS-COV-2 ==================
2025-07-17 12:18:38,390 - INFO - --- Executing: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/01_data_acquisition/fetch_data.py --virus sars-cov-2 --config config/config.yaml ---
2025-07-17 12:28:50,904 - INFO - Stdout from step:
INFO: Logging initialized. Log file at: logs/20250717_121838_sars-cov-2_01_fetch_data.log
INFO: Ensuring raw data directory exists: data/raw/sars-cov-2
INFO: Starting Nextstrain data acquisition via URL...
INFO: Step 1: Downloading metadata...
INFO: Downloading from https://data.nextstrain.org/files/ncov/open/metadata.tsv.zst
INFO: Decompressing data/raw/sars-cov-2/temp_raw_metadata.tsv.zst...
INFO: Successfully created data/raw/sars-cov-2/raw_metadata.tsv
INFO: Step 2: Downloading sequences...
INFO: Downloading from https://data.nextstrain.org/files/ncov/open/sequences.fasta.zst
INFO: Decompressing data/raw/sars-cov-2/temp_raw_sequences.fasta.zst...
INFO: Successfully created data/raw/sars-cov-2/raw_sequences.fasta
INFO: Data fetching process for 'sars-cov-2' complete.

2025-07-17 12:28:50,904 - INFO - --- Step Succeeded: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/01_data_acquisition/fetch_data.py --virus sars-cov-2 --config config/config.yaml ---
2025-07-17 12:28:50,904 - INFO - --- Executing: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/02_preprocessing/nextstrain/prep_metadata_nextstrain.py --virus sars-cov-2 --config config/config.yaml ---
2025-07-17 12:35:34,470 - INFO - Stdout from step:
INFO: Logging initialized. Log file at: logs/20250717_122901_sars-cov-2_02.1_prep_metadata_nextstrain.log
INFO: Loading raw metadata from data/raw/sars-cov-2/raw_metadata.tsv...
INFO: Starting preprocessing of Nextstrain metadata with 9351099 rows.
INFO: Step 1: Applying quality filters from config...
INFO:   Filter 'coverage >= 0.99': Removed 3846335 rows.
INFO:   Filter 'missing_data < 589': Removed 0 rows.
INFO:   Filter 'virus == ncov': Removed 0 rows.
INFO:   Filter 'virus notna None': Removed 0 rows.
INFO:   Filter 'length notna None': Removed 0 rows.
INFO:   Filter 'date_submitted notna None': Removed 0 rows.
INFO:   Filter 'QC_overall_status notna None': Removed 0 rows.
INFO:   Filter 'QC_overall_status != bad': Removed 143624 rows.
INFO:   Filter 'QC_missing_data == good': Removed 0 rows.
INFO:   Filter 'QC_frame_shifts == good': Removed 71750 rows.
INFO:   Filter 'QC_stop_codons == good': Removed 8760 rows.
INFO:   Filter 'QC_mixed_sites == good': Removed 258033 rows.
INFO: Step 2: Checking for special characters in ID...
INFO:   Filter 'Special Chars in ID': Removed 4292794 rows.
INFO: Step 3: Processing lineage column...
INFO: Using source column 'pango_lineage' for lineage information.
INFO:   Identified and removed 0 non-classified rows (missing 'pango_lineage').
INFO: Step 4: Performing final formatting...
INFO: Formatting date columns...
INFO:   - Analyzing and formatting 'Collection date'
INFO:     Removed 407 rows with incomplete 'XXXX' dates.
INFO:     Date format statistics for 'Collection date':
INFO:       YYYY-MM-DD format: 721676
INFO:       YYYY-MM format   : 207
INFO:       YYYY format      : 6943
INFO:       Other/unparseable: 559
INFO:       Missing (NA)     : 11
INFO:   - Analyzing and formatting 'Submission date'
INFO:     Date format statistics for 'Submission date':
INFO:       YYYY-MM-DD format: 729396
INFO:       YYYY-MM format   : 0
INFO:       YYYY format      : 0
INFO:       Other/unparseable: 0
INFO:       Missing (NA)     : 0
INFO: Formatting 'Location' column by combining 'region' and 'country'...
INFO: Preprocessing complete. Final dataset has 729396 rows.
INFO: Saving processed metadata (729396 rows) to data/processed/sars-cov-2/metadata.tsv...
INFO: Saving 8621703 quality-filtered sequence IDs to data/processed/sars-cov-2/filtered_sequence_ids.txt...
INFO: Saving 0 non-classified sequence IDs to data/processed/sars-cov-2/non_classified_sequence_ids.txt...
INFO: Script finished successfully.

2025-07-17 12:35:34,471 - INFO - --- Step Succeeded: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/02_preprocessing/nextstrain/prep_metadata_nextstrain.py --virus sars-cov-2 --config config/config.yaml ---
2025-07-17 12:35:34,471 - INFO - --- Executing: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/04_postprocessing/format_covid_variations.py --virus sars-cov-2 --config config/config.yaml ---
2025-07-17 12:35:45,034 - INFO - Stdout from step:
INFO: Logging initialized. Log file at: logs/20250717_123537_sars-cov-2_04_format_covid_variations.log
INFO: Loading processed metadata from: data/processed/sars-cov-2/metadata.tsv
INFO: Starting transformation of mutation columns...
WARNING: Column 'substitutions' not found. An empty transformed column will be created.
WARNING: Column 'deletions' not found. An empty transformed column will be created.
WARNING: Column 'insertions' not found. An empty transformed column will be created.
INFO: Combining transformed columns into 'mutations' column...
INFO: Mutation processing complete.
INFO: Validating intermediate column formats...
INFO: All format assertions passed successfully!
INFO: Dropping intermediate and original mutation columns...
INFO: Renaming 'Pango lineage' column to 'pangoLin' for consistency...
INFO: Saving reformatted data with 729396 rows to: results/nextstrain_output/sars-cov-2/nextstrain_reformatted.tsv
INFO: Script finished successfully.

2025-07-17 12:35:45,034 - INFO - --- Step Succeeded: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/04_postprocessing/format_covid_variations.py --virus sars-cov-2 --config config/config.yaml ---
2025-07-17 12:35:45,034 - INFO - --- Executing: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/05_prepare_recombinhunt/create_environment.py --virus sars-cov-2 --config config/config.yaml ---
2025-07-17 12:35:47,543 - ERROR - --- Step FAILED: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/05_prepare_recombinhunt/create_environment.py --virus sars-cov-2 --config config/config.yaml ---
2025-07-17 12:35:47,544 - ERROR - Return Code: 1
2025-07-17 12:35:47,544 - ERROR - Stderr:
Traceback (most recent call last):
  File "/home/topcuoglu/.local/lib/python3.10/site-packages/pandas/core/indexes/base.py", line 3790, in get_loc
    return self._engine.get_loc(casted_key)
  File "index.pyx", line 152, in pandas._libs.index.IndexEngine.get_loc
  File "index.pyx", line 181, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7080, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'pangoLin'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/topcuoglu/openrecombinhunt/src/05_prepare_recombinhunt/create_environment.py", line 377, in <module>
    main()
  File "/home/topcuoglu/openrecombinhunt/src/05_prepare_recombinhunt/create_environment.py", line 348, in main
    genome_counts_non_recombinants, variation_counts_non_recombinants = get_lineage_and_variation_counts(
  File "/home/topcuoglu/openrecombinhunt/src/05_prepare_recombinhunt/create_environment.py", line 93, in get_lineage_and_variation_counts
    genome_counter_by_lineage = df['pangoLin'].value_counts().to_dict()
  File "/home/topcuoglu/.local/lib/python3.10/site-packages/pandas/core/frame.py", line 3896, in __getitem__
    indexer = self.columns.get_loc(key)
  File "/home/topcuoglu/.local/lib/python3.10/site-packages/pandas/core/indexes/base.py", line 3797, in get_loc
    raise KeyError(key) from err
KeyError: 'pangoLin'

2025-07-17 12:35:47,544 - ERROR - Stdout:
INFO: Logging initialized. Log file at: logs/20250717_123545_sars-cov-2_05.1_create_environment.log
INFO: Virus is 'sars-cov-2'. Using Nextstrain reformatted as input.
INFO: Environment files will be saved to: environments/sars-cov-2/dist0size0
INFO: Loading data from: results/nextstrain_output/sars-cov-2/nextstrain_reformatted.tsv
INFO: Initial row count: 729,396
INFO: Dropped 729,396 rows with missing or empty 'mutations' column.
INFO: Row count after cleaning: 0
INFO: Calculating change probabilities...
WARNING: Input DataFrame is empty. Cannot calculate change probabilities.
INFO: Calculating genome and variation counts per lineage...
INFO:   Found 0 unique lineages in the dataset.
INFO:   Finished calculating genome and variation counts.
INFO: 
Calculating 'lc_df.parquet'...
INFO: 
--- Running common logic: calculating lineage mutation frequencies ---
INFO: Selected 0 lineages with at least 10 genomes.
INFO: Warning: No lineages met the min_genome_count requirement.
INFO: 
Calculating 'change2lineage_probability.parquet'...
INFO: 
--- Running common logic: calculating lineage mutation frequencies ---
INFO: Selected 0 lineages with at least 10 genomes.
INFO: Warning: No lineages met the min_genome_count requirement.
INFO: 
Calculating 'lc_quality_df.parquet'...
Warning: genome_counter_by_lineage is empty. Returning an empty DataFrame.
INFO: Saving environment files...
INFO: Virus is 'sars-cov-2'. Saving two versions of lineage characterisations.
INFO: Calculating genome and variation counts per lineage...

2025-07-17 12:35:47,544 - CRITICAL - Pipeline for 'sars-cov-2' failed at step: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/05_prepare_recombinhunt/create_environment.py --virus sars-cov-2 --config config/config.yaml
2025-07-17 12:35:47,544 - CRITICAL - Aborting pipeline for this virus.
2025-07-17 12:35:47,544 - INFO - ================== PIPELINE FOR SARS-COV-2 FINISHED ==================


