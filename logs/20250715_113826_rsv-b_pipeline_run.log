2025-07-15 11:38:26,552 - INFO - Logging initialized. Log file at: logs/20250715_113826_rsv-b_pipeline_run.log
2025-07-15 11:38:26,553 - INFO - ================== STARTING PIPELINE FOR: RSV-B ==================
2025-07-15 11:38:26,553 - INFO - --- Executing: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/01_data_acquisition/fetch_data.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:38:28,509 - INFO - Stdout from step:
INFO: Logging initialized. Log file at: logs/20250715_113826_rsv-b_01_fetch_data.log
INFO: Ensuring raw data directory exists: data/raw/rsv-b
INFO: Starting Nextstrain data acquisition via URL...
INFO: Step 1: Downloading metadata from https://data.nextstrain.org/files/workflows/rsv/b/metadata.tsv.gz
INFO: Decompressing data/raw/rsv-b/temp_metadata.tsv.gz...
INFO: Step 2: Downloading sequences from https://data.nextstrain.org/files/workflows/rsv/b/sequences.fasta.xz
INFO: Decompressing data/raw/rsv-b/temp_sequences.fasta.xz...
INFO: Step 3: Fetching reference sequence from NCBI...
INFO: Fetching reference sequence from NCBI...
INFO: Executing: datasets download virus genome accession NC_001781.1 --include genome --filename rsv-b-reference.zip
INFO: Unzipping data/raw/rsv-b/temp_ref_download/rsv-b-reference.zip...
INFO: Found: data/raw/rsv-b/temp_ref_download/ncbi_dataset/data/genomic.fna. Moving and renaming to data/raw/rsv-b/reference.fasta
INFO: Cleaning up temporary reference sequence files...
INFO: Data fetching process for 'rsv-b' complete.

2025-07-15 11:38:28,510 - INFO - --- Step Succeeded: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/01_data_acquisition/fetch_data.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:38:28,510 - INFO - --- Executing: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/02_preprocessing/nextstrain/prep_metadata_nextstrain.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:38:29,734 - INFO - Stdout from step:
INFO: Logging initialized. Log file at: logs/20250715_113829_rsv-b_02.1_prep_metadata_nextstrain.log
INFO: Loading raw metadata from data/raw/rsv-b/raw_metadata.tsv...
INFO: Starting preprocessing of Nextstrain metadata with 22427 rows.
INFO: Step 1: Applying quality filters from config...
INFO:   Filter 'accession notna None': Removed 0 rows.
INFO:   Filter 'date notna None': Removed 0 rows.
INFO:   Filter 'qc.overallStatus == good': Removed 829 rows.
INFO:   Filter 'missing_data < 3': Removed 2916 rows.
INFO: Step 2: Checking for special characters in ID...
INFO:   Filter 'Special Chars in ID': Removed 0 rows.
INFO: Step 3: Processing lineage column...
INFO: Using source column 'clade' for lineage information.
INFO:   Identified and removed 0 non-classified rows (missing 'clade').
INFO: Step 4: Performing final formatting...
INFO: Formatting date columns...
INFO:   - Analyzing and formatting 'Collection date'
INFO:     Removed 1418 rows with incomplete 'XXXX' dates.
INFO:     Date format statistics for 'Collection date':
INFO:       YYYY-MM-DD format: 11751
INFO:       YYYY-MM format   : 0
INFO:       YYYY format      : 0
INFO:       Other/unparseable: 5513
INFO:       Missing (NA)     : 0
INFO:   - Analyzing and formatting 'Submission date'
INFO:     Date format statistics for 'Submission date':
INFO:       YYYY-MM-DD format: 17264
INFO:       YYYY-MM format   : 0
INFO:       YYYY format      : 0
INFO:       Other/unparseable: 0
INFO:       Missing (NA)     : 0
INFO: Formatting 'Location' column by combining 'region' and 'country'...
INFO: Preprocessing complete. Final dataset has 17264 rows.
INFO: Saving processed metadata (17264 rows) to data/processed/rsv-b/metadata.tsv...
INFO: Saving 5163 quality-filtered sequence IDs to data/processed/rsv-b/filtered_sequence_ids.txt...
INFO: Saving 0 non-classified sequence IDs to data/processed/rsv-b/non_classified_sequence_ids.txt...
INFO: Script finished successfully.

2025-07-15 11:38:29,734 - INFO - --- Step Succeeded: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/02_preprocessing/nextstrain/prep_metadata_nextstrain.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:38:29,734 - INFO - --- Executing: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/02_preprocessing/common/prep_fasta.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:38:31,071 - INFO - Stdout from step:
INFO: Logging initialized. Log file at: logs/20250715_113830_rsv-b_02.2_prep_fasta.log
INFO: Loading IDs of sequences to be dropped...
INFO: Loading IDs from: data/processed/rsv-b/filtered_sequence_ids.txt
INFO: Loaded 5163 unique IDs.
INFO: Loading IDs from: data/processed/rsv-b/non_classified_sequence_ids.txt
INFO: Loaded 0 unique IDs.
INFO: NUmber of Filtered IDs: 5163
INFO: Number of Non-Classified IDs: 0
INFO: Total unique IDs to drop from FASTA file: 5163
INFO: Filtering FASTA file: data/raw/rsv-b/raw_sequences.fasta...
INFO: Removing sequences whose ID is in the combined dropped list (5163 total IDs).
INFO: FASTA Filtering Summary:
INFO:   Original sequences read: 22427
INFO:   Sequences dropped      : 5163
INFO:   Sequences kept         : 17264
INFO: Filtered FASTA saved to  : data/processed/rsv-b/sequences.fasta
INFO: Script finished successfully.

2025-07-15 11:38:31,072 - INFO - --- Step Succeeded: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/02_preprocessing/common/prep_fasta.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:38:31,072 - INFO - --- Executing: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/02_preprocessing/common/prep_ref.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:38:31,167 - INFO - Stdout from step:
INFO: Logging initialized. Log file at: logs/20250715_113831_rsv-b_02.3_prep_ref.log
INFO: Copying reference sequence...
INFO:   Source: data/raw/rsv-b/reference.fasta
INFO:   Destination: data/processed/rsv-b/reference.fasta
INFO: Reference sequence successfully copied to processed directory.
INFO: Script finished successfully.

2025-07-15 11:38:31,167 - INFO - --- Step Succeeded: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/02_preprocessing/common/prep_ref.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:38:31,167 - INFO - --- Executing: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/03_haplocov/run_haplocov.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:42:07,565 - INFO - Stdout from step:
INFO: Logging initialized. Log file at: logs/20250715_113831_rsv-b_03_run_haplocov.log
INFO: --- Starting Step 3: Run HaploCoV for 'rsv-b' ---
INFO: Created temporary working directory: results/haplocov_output/rsv-b/dist5size50/temp_work
INFO: Creating symbolic links for input files in temporary directory...
INFO: Executing HaploCoV with designation_mode: 'both'
INFO: Executing: perl ../../../../../libs/haplocov/addToTableNCBI.pl --metadata metadata.tsv --ref reference.fasta --seq sequences.fasta --outfile out.HaploCoV --nproc 16
INFO: Executing: perl ../../../../../libs/haplocov/computeDefining.pl out.HaploCoV
INFO: Executing: perl ../../../../../libs/haplocov/assign.pl --dfile out.HaploCoV.definingVariants.txt --infile out.HaploCoV --outfile out.HaploCoV.assigned
INFO: Executing: perl ../../../../../libs/haplocov/augmentClusters.pl --metafile out.HaploCoV.assigned --deffile out.HaploCoV.definingVariants.txt --posFile out.HaploCoV.frequentVariants.txt --outfile out.HaploCoV.definingVariantsNew.txt --dist 5 --size 50
INFO: Executing: perl ../../../../../libs/haplocov/assign.pl --dfile out.HaploCoV.definingVariantsNew.txt --infile out.HaploCoV --outfile out.HaploCoV.assignedNew
INFO: Executing: cut -f 10 out.HaploCoV.assignedNew | sort | uniq -c > rsv-b-report.txt
INFO: Moving final output file 'out.HaploCoV.assignedNew' to 'results/haplocov_output/rsv-b/dist5size50/haplocov_assigned.tsv'
INFO: HaploCoV step completed.
INFO: HaploCoV step finished successfully.

2025-07-15 11:42:07,566 - INFO - --- Step Succeeded: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/03_haplocov/run_haplocov.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:42:07,567 - INFO - --- Executing: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/04_postprocessing/format_haplocov_variations.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:42:10,217 - INFO - Stdout from step:
INFO: Logging initialized. Log file at: logs/20250715_114208_rsv-b_04_postprocess_haplocov.log
INFO: Loading HaploCoV output from: results/haplocov_output/rsv-b/dist5size50/haplocov_assigned.tsv
INFO: Reformatting mutations in the 'listV' column...
INFO: Saving reformatted data to: results/haplocov_output/rsv-b/dist5size50/haplocov_reformatted.tsv
INFO: Script finished successfully.

2025-07-15 11:42:10,217 - WARNING - Stderr from step:

Formatting mutations:   0%|          | 0/17264 [00:00<?, ?it/s]
Formatting mutations:  17%|█▋        | 2941/17264 [00:00<00:00, 29399.30it/s]
Formatting mutations:  34%|███▍      | 5881/17264 [00:00<00:00, 22986.61it/s]
Formatting mutations:  48%|████▊     | 8265/17264 [00:00<00:00, 20828.32it/s]
Formatting mutations:  60%|██████    | 10397/17264 [00:00<00:00, 17568.60it/s]
Formatting mutations:  71%|███████   | 12220/17264 [00:00<00:00, 17301.98it/s]
Formatting mutations:  83%|████████▎ | 14339/17264 [00:00<00:00, 18410.02it/s]
Formatting mutations:  94%|█████████▍| 16226/17264 [00:00<00:00, 16554.12it/s]
Formatting mutations: 100%|██████████| 17264/17264 [00:01<00:00, 16393.70it/s]

2025-07-15 11:42:10,217 - INFO - --- Step Succeeded: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/04_postprocessing/format_haplocov_variations.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:42:10,217 - INFO - --- Executing: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/05_prepare_recombinhunt/create_environment.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:42:14,400 - INFO - Stdout from step:
INFO: Logging initialized. Log file at: logs/20250715_114210_rsv-b_05.1_create_environment.log
INFO: Virus is 'rsv-b'. Using HaploCoV reformatted output as input.
INFO: Environment files will be saved to: environments/rsv-b/dist5size50
INFO: Loading data from: results/haplocov_output/rsv-b/dist5size50/haplocov_reformatted.tsv
INFO: Calculating change probabilities...
INFO:   Total sequences for calculation: 17,264
INFO:   Found 16,727 unique mutations across all sequences.
INFO:   Finished calculating change probabilities. Shape of result: (16727, 2)
INFO: Calculating genome and variation counts per lineage...
INFO:   Found 22 unique lineages in the dataset.
INFO:   Finished calculating genome and variation counts.
INFO: 
Calculating 'lc_df.parquet'...
INFO: 
--- Running common logic: calculating lineage mutation frequencies ---
INFO: Selected 22 lineages with at least 10 genomes.
INFO: Removed 0 mutations that were not characteristic of any lineage.
INFO: lc_df calculation complete.
INFO: 
Calculating 'change2lineage_probability.parquet'...
INFO: 
--- Running common logic: calculating lineage mutation frequencies ---
INFO: Selected 22 lineages with at least 10 genomes.
INFO: change2lineage_probability calculation complete.
INFO: 
Calculating 'lc_quality_df.parquet'...
INFO: lc_quality_df calculation complete.
INFO: Saving environment files...
INFO: Environment creation complete.

2025-07-15 11:42:14,400 - INFO - --- Step Succeeded: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/05_prepare_recombinhunt/create_environment.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:42:14,400 - INFO - --- Executing: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/05_prepare_recombinhunt/create_samples.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:42:15,972 - INFO - Stdout from step:
INFO: Logging initialized. Log file at: logs/20250715_114215_rsv-b_05.2_create_samples.log
INFO: --- Starting Step 5.2: Create Samples for 'rsv-b' ---
INFO: Virus is 'rsv-b'. Using HaploCoV reformatted output as input.
INFO: Sample files will be saved to: samples/rsv-b/dist5size50
INFO: Loading data from: results/haplocov_output/rsv-b/dist5size50/haplocov_reformatted.tsv
INFO: Cleaning data by dropping rows with missing pangoLin or mutations...
WARNING: Found 1 sequences with missing 'mutations'. They will be dropped.
WARNING:   Dropped IDs (missing mutations): ['KY078406']
INFO: Initially, there were 17264 rows.
INFO: Data cleaning complete. 17263 rows remaining for sample creation.
INFO: Grouping by lineage and creating sample files...
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.csv (19 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.3.csv (35 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.csv (193 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.1.csv (399 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.1.1.csv (103 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.1.NmC1.csv (1410 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.2.csv (655 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.3.csv (215 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.4.csv (2010 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.4.1.csv (617 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.4.1.1.csv (259 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.4.1.1.NmC1.csv (2198 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.4.1.2.csv (1251 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.4.1.3.NmC1.csv (1267 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.4.NmC1.csv (1292 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.E.1.csv (714 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.E.1.1.csv (46 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.E.1.2.csv (89 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.E.2.csv (1275 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.E.4.csv (1317 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.E.5.csv (277 rows)
INFO:   Saved: samples/rsv-b/dist5size50/samples_B.D.NmC1.csv (1622 rows)
INFO: Saving lineage count summary to: samples/rsv-b/dist5size50/samples_total.json
INFO: Sample creation step finished successfully.

2025-07-15 11:42:15,973 - INFO - --- Step Succeeded: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/05_prepare_recombinhunt/create_samples.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:42:15,973 - INFO - --- Executing: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/06_recombinhunt/run_recombinhunt.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:42:17,242 - ERROR - --- Step FAILED: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/06_recombinhunt/run_recombinhunt.py --virus rsv-b --config config/config.yaml ---
2025-07-15 11:42:17,242 - ERROR - Return Code: 1
2025-07-15 11:42:17,242 - ERROR - Stderr:
/home/topcuoglu/openrecombinhunt/libs/recombinhunt-cov-7.0.0/src/recombinhunt/core/environment.py:237: UserWarning: RecombinHunt 5.+ expects a candidates_hierarchy.json in the environment dir but the file is missing. Backward compatibility is possible by calling Environment.embed_candidates_hierarchy() with a CandidatesHierarchy object. Resorting to default CandidatesHierarchy.
  warnings.warn("RecombinHunt 5.+ expects a candidates_hierarchy.json in the environment dir but the file is missing. Backward compatibility is possible by"

2025-07-15 11:42:17,243 - ERROR - Stdout:
INFO: Logging initialized. Log file at: logs/20250715_114217_rsv-b_06_run_recombinhunt.log
INFO: --- Starting Step 6: Run RecombinHunt for 'rsv-b' ---
INFO: Loading RecombinHunt environment from: environments/rsv-b/dist5size50
Starting formal checks of the environment...
CRITICAL: Failed to load a valid RecombinHunt environment from environments/rsv-b/dist5size50: Column 'pos' in table 'change2lineage_probability' is not of intger type

2025-07-15 11:42:17,243 - CRITICAL - Pipeline for 'rsv-b' failed at step: /home/topcuoglu/miniconda3/envs/orh/bin/python3 src/06_recombinhunt/run_recombinhunt.py --virus rsv-b --config config/config.yaml
2025-07-15 11:42:17,243 - CRITICAL - Aborting pipeline for this virus.
2025-07-15 11:42:17,243 - INFO - ================== PIPELINE FOR RSV-B FINISHED ==================


